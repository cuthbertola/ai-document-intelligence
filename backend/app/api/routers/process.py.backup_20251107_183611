from fastapi import APIRouter, HTTPException, Depends
from fastapi.responses import JSONResponse
from pathlib import Path
import PyPDF2
from sqlalchemy.orm import Session
from app.db.session import get_db
import json
from datetime import datetime

router = APIRouter(prefix="/api/v1", tags=["process"])

PROCESSED_DIR = Path("/Users/olawalebadekale/ai-document-platform/data/processed")

@router.post("/process/{document_id}")
async def process_document(document_id: int, db: Session = Depends(get_db)):
    """Process a document with OCR."""
    
    try:
        # Find a PDF that needs processing
        pdf_files = list(PROCESSED_DIR.glob("*.pdf"))
        
        # Find the most recent PDF without a corresponding .txt file
        for pdf_path in sorted(pdf_files, key=lambda x: x.stat().st_mtime, reverse=True):
            txt_path = pdf_path.with_suffix('.txt')
            
            # If this PDF doesn't have a text file, process it
            if not txt_path.exists():
                text = ""
                try:
                    with open(pdf_path, 'rb') as file:
                        pdf_reader = PyPDF2.PdfReader(file)
                        for page in pdf_reader.pages:
                            page_text = page.extract_text()
                            if page_text:
                                text += page_text + "\n"
                except Exception as e:
                    text = f"Error extracting text: {e}"
                
                # Save the extracted text
                with open(txt_path, 'w', encoding='utf-8') as f:
                    f.write(text)
                
                word_count = len(text.split())
                
                # Save metadata
                metadata = {
                    "document_id": document_id,
                    "filename": pdf_path.name,
                    "processed_at": datetime.now().isoformat(),
                    "word_count": word_count
                }
                
                metadata_path = PROCESSED_DIR / f"{pdf_path.stem}_metadata.json"
                with open(metadata_path, 'w') as f:
                    json.dump(metadata, f, indent=2)
                
                return JSONResponse({
                    "status": "success",
                    "word_count": word_count,
                    "message": f"Document processed successfully. {word_count} words extracted."
                })
        
        # If all PDFs have text files, return success
        return JSONResponse({
            "status": "success",
            "message": "Document already processed or no PDF found."
        })
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
